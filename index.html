<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xendra AI v13.2 - Persistent Session</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="fav.png" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #login-overlay {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hide {
            display: none !important;
        }

        .markdown-content h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 2rem 0 1rem;
            color: #3b82f6;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            color: #60a5fa;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem;
            color: #93c5fd;
        }

        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: #e2e8f0;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0 1rem 2rem;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
            color: #cbd5e1;
        }

        .markdown-content code {
            background: rgba(15, 23, 42, 0.8);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: #f87171;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .result-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 1.5rem;
        }

        .chat-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-bolt text-5xl text-blue-500 mb-4 block"></i>
                <h1 class="text-3xl font-bold">XENDRA AI</h1>
                <p class="text-slate-400 mt-2 text-sm">v13 Persistent Session</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <input type="password" id="passwordInput" placeholder="Masukkan Password" 
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center focus:ring-2 focus:ring-blue-500 outline-none text-white placeholder-slate-500">
                    <div id="passwordStatus" class="absolute right-4 top-4 hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
                <button id="loginBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-xl transition shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i> ACCESS SYSTEM
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden"></p>
                <p id="loginInfo" class="text-blue-400 text-xs text-center">Siap untuk login</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="h-screen flex flex-col hide">
        <!-- Header -->
        <header class="glass border-b border-slate-700 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-bolt text-blue-500 text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold">XENDRA AI</h1>
                    <p class="text-xs text-slate-400">v13 Persistent - Global History</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="newChatBtn" class="bg-slate-700/50 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-plus mr-2"></i> New Chat
                </button>
                <button id="logoutBtn" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-grow overflow-hidden flex gap-4 p-4">
            <!-- Left: Chat View (Always Visible) -->
            <div id="chat-section" class="w-full lg:w-1/2 flex flex-col">
                <div id="chat-container" class="flex-grow overflow-y-auto space-y-4 mb-4">
                    <div class="text-center mt-20 text-slate-500">
                        <i class="fas fa-robot text-6xl mb-4 block opacity-30"></i>
                        <p class="text-lg font-medium">Halo! Saya Xendra AI</p>
                        <p class="text-sm mt-2">Siap membantu membuat artikel, gambar, atau kode Anda</p>
                    </div>
                </div>

                <!-- Input (ALWAYS VISIBLE) -->
                <div class="glass rounded-xl p-3 flex gap-2">
                    <textarea id="chatInput" placeholder="Tanya sesuatu... (Enter: Kirim, Shift+Enter: Baris Baru)" 
                        class="flex-grow bg-transparent border-none focus:ring-0 outline-none text-white placeholder-slate-500 resize-none" rows="1"></textarea>
                    <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition disabled:opacity-50">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Right: Result View (Appears on Split) -->
            <div id="result-section" class="hidden lg:flex w-1/2 flex-col">
                <div class="glass rounded-xl p-6 overflow-y-auto flex-grow">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-blue-400">
                        <i class="fas fa-list-check mr-2"></i> Hasil & Rencana
                    </h3>
                    
                    <!-- Image Container -->
                    <div id="result-image-container" class="mb-6">
                        <!-- Image akan ditampilkan di sini -->
                    </div>

                    <!-- Phases -->
                    <div id="phase-list" class="space-y-2 mb-6">
                        <!-- Phases injected here -->
                    </div>

                    <!-- Result Content -->
                    <div id="result-container" class="markdown-content">
                        <!-- Result injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PENTING: Ganti URL ini dengan URL Cloudflare Worker Anda
        const API_URL = 'https://xendra-backend.beautifulplace.workers.dev/';
        const SESSION_KEY = 'xendra_session';
        const PASSWORD_KEY = 'xendra_password';
        
        let currentPassword = '';
        let isProcessing = false;
        let conversationContext = [];
        let isAuthenticated = false;

        // Elements
        const loginOverlay = document.getElementById('login-overlay');
        const app = document.getElementById('app');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const loginInfo = document.getElementById('loginInfo');
        const passwordStatus = document.getElementById('passwordStatus');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chat-container');
        const resultSection = document.getElementById('result-section');
        const resultImageContainer = document.getElementById('result-image-container');
        const phaseList = document.getElementById('phase-list');
        const resultContainer = document.getElementById('result-container');

        // Initialize: Cek apakah user sudah login sebelumnya
        window.addEventListener('load', initializeApp);

        async function initializeApp() {
            const savedPassword = localStorage.getItem(PASSWORD_KEY);
            
            if (savedPassword) {
                // User sudah pernah login, verifikasi ulang
                currentPassword = savedPassword;
                await verifyAndLogin();
            }
        }

        async function verifyAndLogin() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'verify_password',
                        password: currentPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.authenticated) {
                    isAuthenticated = true;
                    loginOverlay.classList.add('hide');
                    app.classList.remove('hide');
                    
                    // Load history dari KV
                    await loadChatHistory();
                    chatInput.focus();
                } else {
                    // Password tidak valid lagi, hapus dari localStorage
                    localStorage.removeItem(PASSWORD_KEY);
                    currentPassword = '';
                }
            } catch (error) {
                console.error('Verification failed:', error);
                localStorage.removeItem(PASSWORD_KEY);
                currentPassword = '';
            }
        }

        // Login Handler
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleLogin(); });

        async function handleLogin() {
            const pass = passwordInput.value.trim();
            if (!pass) {
                showLoginError('Masukkan password terlebih dahulu!');
                return;
            }

            loginBtn.disabled = true;
            passwordStatus.classList.remove('hidden');
            loginInfo.textContent = 'Verifikasi password...';
            loginError.classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'verify_password',
                        password: pass
                    })
                });

                const data = await response.json();

                if (response.ok && data.authenticated) {
                    currentPassword = pass;
                    isAuthenticated = true;
                    
                    // Simpan password ke localStorage (untuk persistent session)
                    localStorage.setItem(PASSWORD_KEY, pass);
                    
                    loginOverlay.classList.add('hide');
                    app.classList.remove('hide');
                    
                    // Load history dari KV
                    await loadChatHistory();
                    chatInput.focus();
                } else {
                    showLoginError('Password salah! Coba lagi.');
                    passwordInput.value = '';
                    loginInfo.textContent = 'Verifikasi gagal';
                }
            } catch (error) {
                showLoginError('Gagal terhubung ke server: ' + error.message);
                loginInfo.textContent = 'Koneksi error';
            } finally {
                loginBtn.disabled = false;
                passwordStatus.classList.add('hidden');
            }
        }

        function showLoginError(msg) {
            loginError.textContent = '❌ ' + msg;
            loginError.classList.remove('hidden');
        }

        // Load Chat History dari KV Storage
        async function loadChatHistory() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'get_history',
                        password: currentPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.history && data.history.length > 0) {
                    // Clear chat container
                    chatContainer.innerHTML = '';
                    
                    // Load history
                    conversationContext = data.history;
                    
                    // Display history messages
                    data.history.forEach(msg => {
                        if (msg.role === 'user') {
                            addMessage('user', msg.content);
                        } else {
                            addMessage('ai', msg.content);
                        }
                    });
                } else {
                    // Tidak ada history, tampilkan welcome message
                    chatContainer.innerHTML = `
                        <div class="text-center mt-20 text-slate-500">
                            <i class="fas fa-robot text-6xl mb-4 block opacity-30"></i>
                            <p class="text-lg font-medium">Halo! Saya Xendra AI</p>
                            <p class="text-sm mt-2">Siap membantu membuat artikel, gambar, atau kode Anda</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading history:', error);
                // Jika gagal load history, tetap bisa chat
            }
        }

        // Auto-grow textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Send message
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing || !isAuthenticated) return;

            isProcessing = true;
            sendBtn.disabled = true;

            addMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';

            conversationContext.push({ role: 'user', content: message });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'chat',
                        message, 
                        password: currentPassword,
                        context: conversationContext
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    resultSection.classList.remove('hidden');
                    showPhases(data.phases);
                    showResult(data);
                    conversationContext.push({ role: 'assistant', content: data.message });
                    addMessage('ai', data.message, data.imageUrl);
                } else {
                    addMessage('error', data.error || 'Terjadi kesalahan');
                }
            } catch (error) {
                addMessage('error', 'Gagal terhubung ke server: ' + error.message);
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function addMessage(role, text, imageUrl = null) {
            const div = document.createElement('div');
            div.className = `chat-message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            if (role === 'error') {
                div.innerHTML = `
                    <div class="bg-red-900/30 border border-red-500/50 text-red-200 px-4 py-3 rounded-lg max-w-md flex items-center gap-2">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${text}</span>
                    </div>
                `;
            } else {
                const bgClass = role === 'user' ? 'bg-blue-600' : 'glass';
                div.innerHTML = `
                    <div class="${bgClass} px-4 py-3 rounded-lg max-w-2xl">
                        ${imageUrl ? `<img src="${imageUrl}" class="rounded-lg mb-3 w-full max-h-64 object-cover shadow-lg" alt="Generated" onerror="this.style.display='none'">` : ''}
                        <div class="markdown-content text-sm">${marked.parse(text || '')}</div>
                    </div>
                `;
            }

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showPhases(phases) {
            phaseList.innerHTML = '';
            if (phases && phases.length > 0) {
                phases.forEach((phase) => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-900/20 border border-blue-500/30 p-2 rounded text-xs';
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full bg-green-500/30 flex items-center justify-center text-xs">✓</div>
                            <div>
                                <div class="font-semibold text-blue-300">${phase.name}</div>
                                <div class="text-slate-400">${phase.status}</div>
                            </div>
                        </div>
                    `;
                    phaseList.appendChild(div);
                });
            }
        }

        function showResult(data) {
            resultImageContainer.innerHTML = '';

            if (data.imageUrl && data.imageUrl.trim() !== '') {
                const img = document.createElement('img');
                img.src = data.imageUrl;
                img.className = 'result-image';
                img.alt = 'Generated Image';
                img.onerror = function() { 
                    console.log('Image failed to load:', data.imageUrl);
                    this.style.display = 'none'; 
                };
                img.onload = function() {
                    console.log('Image loaded successfully');
                };
                resultImageContainer.appendChild(img);
            }

            resultContainer.innerHTML = marked.parse(data.message || '');
        }

        document.getElementById('newChatBtn').onclick = () => {
            chatContainer.innerHTML = `
                <div class="text-center mt-20 text-slate-500">
                    <i class="fas fa-robot text-6xl mb-4 block opacity-30"></i>
                    <p class="text-lg font-medium">Chat Baru Dimulai</p>
                </div>
            `;
            resultSection.classList.add('hidden');
            resultImageContainer.innerHTML = '';
            conversationContext = [];
            chatInput.focus();
        };

        document.getElementById('logoutBtn').onclick = () => {
            // Hapus session dari localStorage
            localStorage.removeItem(PASSWORD_KEY);
            isAuthenticated = false;
            currentPassword = '';
            conversationContext = [];
            window.location.reload();
        };
    </script>
</body>
</html>
